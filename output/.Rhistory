mdat <- droplevels(mdat)
usedat[[i]] <- mdat
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$success))
# create different formulas to use depending on whether management variable is 1 or 2 levels
if (length(levels(mdat[,mgmtvars[i]])) > 1) {
modform <- as.formula(paste("success ~ ", mgmtvars[i], "*metric + (1|reference) + (1|species)", sep=""))
}
if (length(levels(mdat[,mgmtvars[i]])) < 2) {
modform <- as.formula("success ~ metric + (1|reference) + (1|species)")
}
# run a normal glmer model
m.ind.sp[[i]] <- glmer(modform, data=mdat, family=binomial, control=glmerControl(optimizer="bobyqa"))
# if ANY checkzeros==0, then there are categories which are missing any observations whatsoever, so will have problems with complete separation and/or convergence
# use bglmer since there are some cases of singularity produced by 0/1 not having any observations for some of the categorical variables
# calculate the dimensions of the covariance matrix for bglmer, based on the dimensions of the covariance matrix from the regular glmer model
# if (any(checkzeros==0)) {
vcov.dim <- nrow(vcov(m.ind.sp[[i]]))
m.ind.sp.blme[[i]] <- bglmer(modform, data=mdat, family=binomial, fixef.prior = normal(cov = diag(9,vcov.dim)), control=glmerControl(optimizer="bobyqa"))
# }
mgmtvars[i]
mdat <- metricdat[metricdat[,mgmtvars[i]]!="none",]
table(mdat[,mgmtvars[i]], mdat$metric, mdat$success)
# for the following categories, subset further because there aren't enough observations of either 0,1 or both
#   if (mgmtvars[i]=="reserve.desig") {
#     mdat <- subset(mdat, metric!="productivity")
#   }
if (mgmtvars[i]=="mowing") {
mdat <- subset(mdat, mowing!="applied")
}
#   if (mgmtvars[i]=="grazing") {
#     mdat <- subset(mdat, metric!="occupancy")
#   }
if (mgmtvars[i]=="fertpest") {
# mdat <- subset(mdat, fertpest!="applied")
mdat <- subset(mdat, metric!="occupancy")
}
if (mgmtvars[i]=="predator.control") {
mdat <- subset(mdat, predator.control!="reduced")
}
if (mgmtvars[i]=="water") {
# mdat <- subset(mdat, water!="reduced")
mdat <- subset(mdat, metric!="occupancy")
# model runs ok without 2 of curlew, oystercatcher and snipe, but model won't converge and has a very high max|grad| value when more than 1 of these species is included. Since they all have no successes for this management intervention and similar levels of failure, then combine together for the water analysis
# mdat <- subset(mdat, species!="curlew" & species!="oystercatcher")
# mdat$species <- ifelse(mdat$species=="oystercatcher" | mdat$species=="curlew" | mdat$species=="snipe", "OC/CU/SN", as.character(mdat$species))
}
mdat <- droplevels(mdat)
usedat[[i]] <- mdat
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$success))
# create different formulas to use depending on whether management variable is 1 or 2 levels
if (length(levels(mdat[,mgmtvars[i]])) > 1) {
modform <- as.formula(paste("success ~ ", mgmtvars[i], "*metric + (1|reference) + (1|species)", sep=""))
}
if (length(levels(mdat[,mgmtvars[i]])) < 2) {
modform <- as.formula("success ~ metric + (1|reference) + (1|species)")
}
# run a normal glmer model
m.ind.sp[[i]] <- glmer(modform, data=mdat, family=binomial, control=glmerControl(optimizer="bobyqa"))
# if ANY checkzeros==0, then there are categories which are missing any observations whatsoever, so will have problems with complete separation and/or convergence
# use bglmer since there are some cases of singularity produced by 0/1 not having any observations for some of the categorical variables
# calculate the dimensions of the covariance matrix for bglmer, based on the dimensions of the covariance matrix from the regular glmer model
# if (any(checkzeros==0)) {
vcov.dim <- nrow(vcov(m.ind.sp[[i]]))
m.ind.sp.blme[[i]] <- bglmer(modform, data=mdat, family=binomial, fixef.prior = normal(cov = diag(9,vcov.dim)), control=glmerControl(optimizer="bobyqa"))
# }
i<-8
# set up list to output models and model datasets to
m.ind.sp <- list()
m.ind.sp.blme <- list()
usedat <- list() # data subset used to run a model
for (i in 1:length(mgmtvars)) {
mgmtvars[i]
mdat <- metricdat[metricdat[,mgmtvars[i]]!="none",]
table(mdat[,mgmtvars[i]], mdat$metric, mdat$success)
# for the following categories, subset further because there aren't enough observations of either 0,1 or both
#   if (mgmtvars[i]=="reserve.desig") {
#     mdat <- subset(mdat, metric!="productivity")
#   }
if (mgmtvars[i]=="mowing") {
mdat <- subset(mdat, mowing!="applied")
}
#   if (mgmtvars[i]=="grazing") {
#     mdat <- subset(mdat, metric!="occupancy")
#   }
if (mgmtvars[i]=="fertpest") {
# mdat <- subset(mdat, fertpest!="applied")
mdat <- subset(mdat, metric!="occupancy")
}
if (mgmtvars[i]=="predator.control") {
mdat <- subset(mdat, predator.control!="reduced")
}
if (mgmtvars[i]=="water") {
# mdat <- subset(mdat, water!="reduced")
mdat <- subset(mdat, metric!="occupancy")
# model runs ok without 2 of curlew, oystercatcher and snipe, but model won't converge and has a very high max|grad| value when more than 1 of these species is included. Since they all have no successes for this management intervention and similar levels of failure, then combine together for the water analysis
# mdat <- subset(mdat, species!="curlew" & species!="oystercatcher")
# mdat$species <- ifelse(mdat$species=="oystercatcher" | mdat$species=="curlew" | mdat$species=="snipe", "OC/CU/SN", as.character(mdat$species))
}
mdat <- droplevels(mdat)
usedat[[i]] <- mdat
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$success))
# create different formulas to use depending on whether management variable is 1 or 2 levels
if (length(levels(mdat[,mgmtvars[i]])) > 1) {
modform <- as.formula(paste("success ~ ", mgmtvars[i], "*metric + (1|reference) + (1|species)", sep=""))
}
if (length(levels(mdat[,mgmtvars[i]])) < 2) {
modform <- as.formula("success ~ metric + (1|reference) + (1|species)")
}
# run a normal glmer model
m.ind.sp[[i]] <- glmer(modform, data=mdat, family=binomial, control=glmerControl(optimizer="bobyqa"))
# if ANY checkzeros==0, then there are categories which are missing any observations whatsoever, so will have problems with complete separation and/or convergence
# use bglmer since there are some cases of singularity produced by 0/1 not having any observations for some of the categorical variables
# calculate the dimensions of the covariance matrix for bglmer, based on the dimensions of the covariance matrix from the regular glmer model
# if (any(checkzeros==0)) {
vcov.dim <- nrow(vcov(m.ind.sp[[i]]))
m.ind.sp.blme[[i]] <- bglmer(modform, data=mdat, family=binomial, fixef.prior = normal(cov = diag(9,vcov.dim)), control=glmerControl(optimizer="bobyqa"))
# }
}
names(m.ind.sp) <- mgmtvars
names(m.ind.sp.blme) <- mgmtvars
names(usedat) <- mgmtvars
warningmessages.lme4 <- lapply(m.ind.sp, function(x) slot(x, "optinfo")$conv$lme4$messages)
warningmessages.lme4
warningmessages.blme <- lapply(m.ind.sp.blme, function(x) slot(x, "optinfo")$conv$lme4$messages)
warningmessages.blme
i<-8
summary(m.ind.blme[[8]])
summary(m.ind.sp.blme[[8]])
i
mgmtvars[i]
mdat <- metricdat[metricdat[,mgmtvars[i]]!="none",]
table(mdat[,mgmtvars[i]], mdat$metric, mdat$success)
# for the following categories, subset further because there aren't enough observations of either 0,1 or both
#   if (mgmtvars[i]=="reserve.desig") {
#     mdat <- subset(mdat, metric!="productivity")
#   }
if (mgmtvars[i]=="mowing") {
mdat <- subset(mdat, mowing!="applied")
}
#   if (mgmtvars[i]=="grazing") {
#     mdat <- subset(mdat, metric!="occupancy")
#   }
if (mgmtvars[i]=="fertpest") {
# mdat <- subset(mdat, fertpest!="applied")
mdat <- subset(mdat, metric!="occupancy")
}
if (mgmtvars[i]=="predator.control") {
mdat <- subset(mdat, predator.control!="reduced")
}
if (mgmtvars[i]=="water") {
# mdat <- subset(mdat, water!="reduced")
mdat <- subset(mdat, metric!="occupancy")
# model runs ok without 2 of curlew, oystercatcher and snipe, but model won't converge and has a very high max|grad| value when more than 1 of these species is included. Since they all have no successes for this management intervention and similar levels of failure, then combine together for the water analysis
# mdat <- subset(mdat, species!="curlew" & species!="oystercatcher")
# mdat$species <- ifelse(mdat$species=="oystercatcher" | mdat$species=="curlew" | mdat$species=="snipe", "OC/CU/SN", as.character(mdat$species))
}
mdat <- droplevels(mdat)
usedat[[i]] <- mdat
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$success))
# set up list to output models and model datasets to
m.ind.sp <- list()
m.ind.sp.blme <- list()
usedat <- list() # data subset used to run a model
for (i in 1:length(mgmtvars)) {
mgmtvars[i]
mdat <- metricdat[metricdat[,mgmtvars[i]]!="none",]
table(mdat[,mgmtvars[i]], mdat$metric, mdat$success)
mdat <- subset(mdat, species!="ruff" & species!="dunlin")
# for the following categories, subset further because there aren't enough observations of either 0,1 or both
#   if (mgmtvars[i]=="reserve.desig") {
#     mdat <- subset(mdat, metric!="productivity")
#   }
#     if (mgmtvars[i]=="mowing") {
#       mdat <- subset(mdat, mowing!="applied")
#     }
#
#   if (mgmtvars[i]=="grazing") {
#     mdat <- subset(mdat, metric!="occupancy")
#   }
if (mgmtvars[i]=="fertpest") {
# mdat <- subset(mdat, fertpest!="applied")
mdat <- subset(mdat, metric!="occupancy")
}
if (mgmtvars[i]=="predator.control") {
mdat <- subset(mdat, predator.control!="reduced")
}
if (mgmtvars[i]=="water") {
# mdat <- subset(mdat, water!="reduced")
mdat <- subset(mdat, metric!="occupancy")
# model runs ok without 2 of curlew, oystercatcher and snipe, but model won't converge and has a very high max|grad| value when more than 1 of these species is included. Since they all have no successes for this management intervention and similar levels of failure, then combine together for the water analysis
# mdat <- subset(mdat, species!="curlew" & species!="oystercatcher")
# mdat$species <- ifelse(mdat$species=="oystercatcher" | mdat$species=="curlew" | mdat$species=="snipe", "OC/CU/SN", as.character(mdat$species))
}
mdat <- droplevels(mdat)
usedat[[i]] <- mdat
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$success))
# create different formulas to use depending on whether management variable is 1 or 2 levels
if (length(levels(mdat[,mgmtvars[i]])) > 1) {
modform <- as.formula(paste("success ~ ", mgmtvars[i], "*metric + (1|reference) + (1|species)", sep=""))
}
if (length(levels(mdat[,mgmtvars[i]])) < 2) {
modform <- as.formula("success ~ metric + (1|reference) + (1|species)")
}
# run a normal glmer model
m.ind.sp[[i]] <- glmer(modform, data=mdat, family=binomial, control=glmerControl(optimizer="bobyqa"))
# if ANY checkzeros==0, then there are categories which are missing any observations whatsoever, so will have problems with complete separation and/or convergence
# use bglmer since there are some cases of singularity produced by 0/1 not having any observations for some of the categorical variables
# calculate the dimensions of the covariance matrix for bglmer, based on the dimensions of the covariance matrix from the regular glmer model
# if (any(checkzeros==0)) {
vcov.dim <- nrow(vcov(m.ind.sp[[i]]))
m.ind.sp.blme[[i]] <- bglmer(modform, data=mdat, family=binomial, fixef.prior = normal(cov = diag(9,vcov.dim)), control=glmerControl(optimizer="bobyqa"))
# }
}
names(m.ind.sp) <- mgmtvars
names(m.ind.sp.blme) <- mgmtvars
names(usedat) <- mgmtvars
warningmessages.lme4 <- lapply(m.ind.sp, function(x) slot(x, "optinfo")$conv$lme4$messages)
warningmessages.lme4
warningmessages.blme <- lapply(m.ind.sp.blme, function(x) slot(x, "optinfo")$conv$lme4$messages)
warningmessages.blme
i<-4
mgmtvars[i]
mdat <- metricdat[metricdat[,mgmtvars[i]]!="none",]
table(mdat[,mgmtvars[i]], mdat$metric, mdat$success)
mdat <- subset(mdat, species!="ruff" & species!="dunlin")
# for the following categories, subset further because there aren't enough observations of either 0,1 or both
#   if (mgmtvars[i]=="reserve.desig") {
#     mdat <- subset(mdat, metric!="productivity")
#   }
#     if (mgmtvars[i]=="mowing") {
#       mdat <- subset(mdat, mowing!="applied")
#     }
#
#   if (mgmtvars[i]=="grazing") {
#     mdat <- subset(mdat, metric!="occupancy")
#   }
if (mgmtvars[i]=="fertpest") {
# mdat <- subset(mdat, fertpest!="applied")
mdat <- subset(mdat, metric!="occupancy")
}
if (mgmtvars[i]=="predator.control") {
mdat <- subset(mdat, predator.control!="reduced")
}
if (mgmtvars[i]=="water") {
# mdat <- subset(mdat, water!="reduced")
mdat <- subset(mdat, metric!="occupancy")
# model runs ok without 2 of curlew, oystercatcher and snipe, but model won't converge and has a very high max|grad| value when more than 1 of these species is included. Since they all have no successes for this management intervention and similar levels of failure, then combine together for the water analysis
# mdat <- subset(mdat, species!="curlew" & species!="oystercatcher")
# mdat$species <- ifelse(mdat$species=="oystercatcher" | mdat$species=="curlew" | mdat$species=="snipe", "OC/CU/SN", as.character(mdat$species))
}
mdat <- droplevels(mdat)
usedat[[i]] <- mdat
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$success))
# create different formulas to use depending on whether management variable is 1 or 2 levels
if (length(levels(mdat[,mgmtvars[i]])) > 1) {
modform <- as.formula(paste("success ~ ", mgmtvars[i], "*metric + (1|reference) + (1|species)", sep=""))
}
if (length(levels(mdat[,mgmtvars[i]])) < 2) {
modform <- as.formula("success ~ metric + (1|reference) + (1|species)")
}
# run a normal glmer model
m.ind.sp[[i]] <- glmer(modform, data=mdat, family=binomial, control=glmerControl(optimizer="bobyqa"))
# if ANY checkzeros==0, then there are categories which are missing any observations whatsoever, so will have problems with complete separation and/or convergence
# use bglmer since there are some cases of singularity produced by 0/1 not having any observations for some of the categorical variables
# calculate the dimensions of the covariance matrix for bglmer, based on the dimensions of the covariance matrix from the regular glmer model
# if (any(checkzeros==0)) {
vcov.dim <- nrow(vcov(m.ind.sp[[i]]))
m.ind.sp.blme[[i]] <- bglmer(modform, data=mdat, family=binomial, fixef.prior = normal(cov = diag(9,vcov.dim)), control=glmerControl(optimizer="bobyqa"))
# }
summary(m.ind.sp.blme[[4]])
names(m.ind.sp.blme[[4]])
slotNames(m.ind.sp.blme[[8]])
names(summary(m.ind.sp.blme[[4]]))
summary(m.ind.sp.blme[[4]])$vcov
summary(m.ind.sp.blme[[4]])$coefficients
summary(m.ind.sp.blme[[4]])$varcor
summary(m.ind.sp.blme[[4]])$sigma
i
mgmtvars[i]
mdat <- metricdat[metricdat[,mgmtvars[i]]!="none",]
table(mdat[,mgmtvars[i]], mdat$metric, mdat$success)
mdat <- subset(mdat, species!="ruff" & species!="dunlin")
# for the following categories, subset further because there aren't enough observations of either 0,1 or both
#   if (mgmtvars[i]=="reserve.desig") {
#     mdat <- subset(mdat, metric!="productivity")
#   }
#   if (mgmtvars[i]=="mowing") {
#     mdat <- subset(mdat, mowing!="applied")
#   }
#   if (mgmtvars[i]=="grazing") {
#     mdat <- subset(mdat, metric!="occupancy")
#   }
if (mgmtvars[i]=="fertpest") {
# mdat <- subset(mdat, fertpest!="applied")
mdat <- subset(mdat, metric!="occupancy")
}
if (mgmtvars[i]=="predator.control") {
mdat <- subset(mdat, predator.control!="reduced")
}
if (mgmtvars[i]=="water") {
# mdat <- subset(mdat, water!="reduced")
mdat <- subset(mdat, metric!="occupancy")
# model runs ok without 2 of curlew, oystercatcher and snipe, but model won't converge and has a very high max|grad| value when more than 1 of these species is included. Since they all have no successes for this management intervention and similar levels of failure, then combine together for the water analysis
# mdat <- subset(mdat, species!="curlew" & species!="oystercatcher")
# mdat$species <- ifelse(mdat$species=="oystercatcher" | mdat$species=="curlew" | mdat$species=="snipe", "OC/CU/SN", as.character(mdat$species))
}
mdat <- droplevels(mdat)
usedat[[i]] <- mdat
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$success))
# create different formulas to use depending on whether management variable is 1 or 2 levels
if (length(levels(mdat[,mgmtvars[i]])) > 1) {
modform <- as.formula(paste("success ~ ", mgmtvars[i], "*metric + (1|reference) + (1|species)", sep=""))
}
if (length(levels(mdat[,mgmtvars[i]])) < 2) {
modform <- as.formula("success ~ metric + (1|reference) + (1|species)")
}
# run a normal glmer model
m.ind.sp[[i]] <- glmer(modform, data=mdat, family=binomial, control=glmerControl(optimizer="bobyqa"))
# if ANY checkzeros==0, then there are categories which are missing any observations whatsoever, so will have problems with complete separation and/or convergence
# use bglmer since there are some cases of singularity produced by 0/1 not having any observations for some of the categorical variables
# calculate the dimensions of the covariance matrix for bglmer, based on the dimensions of the covariance matrix from the regular glmer model
# if (any(checkzeros==0)) {
vcov.dim <- nrow(vcov(m.ind.sp[[i]]))
m.ind.sp.blme[[i]] <- bglmer(modform, data=mdat, family=binomial, fixef.prior = normal(cov = diag(9,vcov.dim)), control=glmerControl(optimizer="bobyqa"))
# }
summary(m.ind.sp.blme[[4]])$sigma
summary(m.ind.sp.blme[[4]])$varcor
summary(m.ind.sp.blme[[4]])$vcov
summary(m.ind.sp.blme[[4]])
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$success))
mgmtvars[i]
mdat <- metricdat[metricdat[,mgmtvars[i]]!="none",]
table(mdat[,mgmtvars[i]], mdat$metric, mdat$success)
mdat <- subset(mdat, species!="ruff" & species!="dunlin")
# for the following categories, subset further because there aren't enough observations of either 0,1 or both
#   if (mgmtvars[i]=="reserve.desig") {
#     mdat <- subset(mdat, metric!="productivity")
#   }
#   if (mgmtvars[i]=="mowing") {
#     mdat <- subset(mdat, mowing!="applied")
#   }
#   if (mgmtvars[i]=="grazing") {
#     mdat <- subset(mdat, metric!="occupancy")
#   }
if (mgmtvars[i]=="fertpest") {
# mdat <- subset(mdat, fertpest!="applied")
mdat <- subset(mdat, metric!="occupancy")
}
if (mgmtvars[i]=="predator.control") {
mdat <- subset(mdat, predator.control!="reduced")
}
if (mgmtvars[i]=="water") {
# mdat <- subset(mdat, water!="reduced")
mdat <- subset(mdat, metric!="occupancy")
# model runs ok without 2 of curlew, oystercatcher and snipe, but model won't converge and has a very high max|grad| value when more than 1 of these species is included. Since they all have no successes for this management intervention and similar levels of failure, then combine together for the water analysis
# mdat <- subset(mdat, species!="curlew" & species!="oystercatcher")
# mdat$species <- ifelse(mdat$species=="oystercatcher" | mdat$species=="curlew" | mdat$species=="snipe", "OC/CU/SN", as.character(mdat$species))
}
mdat <- droplevels(mdat)
usedat[[i]] <- mdat
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$success))
str(mdat$mgmtvars[[i]])
table(mdat[,mgmtvars[i]])
mgmtvars[i]
mdat <- metricdat[metricdat[,mgmtvars[i]]!="none",]
table(mdat[,mgmtvars[i]], mdat$metric, mdat$success)
mdat <- subset(mdat, species!="ruff" & species!="dunlin")
# for the following categories, subset further because there aren't enough observations of either 0,1 or both
#   if (mgmtvars[i]=="reserve.desig") {
#     mdat <- subset(mdat, metric!="productivity")
#   }
if (mgmtvars[i]=="mowing") {
mdat <- subset(mdat, mowing!="applied")
}
#   if (mgmtvars[i]=="grazing") {
#     mdat <- subset(mdat, metric!="occupancy")
#   }
if (mgmtvars[i]=="fertpest") {
# mdat <- subset(mdat, fertpest!="applied")
mdat <- subset(mdat, metric!="occupancy")
}
if (mgmtvars[i]=="predator.control") {
mdat <- subset(mdat, predator.control!="reduced")
}
if (mgmtvars[i]=="water") {
# mdat <- subset(mdat, water!="reduced")
mdat <- subset(mdat, metric!="occupancy")
# model runs ok without 2 of curlew, oystercatcher and snipe, but model won't converge and has a very high max|grad| value when more than 1 of these species is included. Since they all have no successes for this management intervention and similar levels of failure, then combine together for the water analysis
# mdat <- subset(mdat, species!="curlew" & species!="oystercatcher")
# mdat$species <- ifelse(mdat$species=="oystercatcher" | mdat$species=="curlew" | mdat$species=="snipe", "OC/CU/SN", as.character(mdat$species))
}
mdat <- droplevels(mdat)
usedat[[i]] <- mdat
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$success))
# create different formulas to use depending on whether management variable is 1 or 2 levels
if (length(levels(mdat[,mgmtvars[i]])) > 1) {
modform <- as.formula(paste("success ~ ", mgmtvars[i], "*metric + (1|reference) + (1|species)", sep=""))
}
if (length(levels(mdat[,mgmtvars[i]])) < 2) {
modform <- as.formula("success ~ metric + (1|reference) + (1|species)")
}
# run a normal glmer model
m.ind.sp[[i]] <- glmer(modform, data=mdat, family=binomial, control=glmerControl(optimizer="bobyqa"))
# if ANY checkzeros==0, then there are categories which are missing any observations whatsoever, so will have problems with complete separation and/or convergence
# use bglmer since there are some cases of singularity produced by 0/1 not having any observations for some of the categorical variables
# calculate the dimensions of the covariance matrix for bglmer, based on the dimensions of the covariance matrix from the regular glmer model
# if (any(checkzeros==0)) {
vcov.dim <- nrow(vcov(m.ind.sp[[i]]))
m.ind.sp.blme[[i]] <- bglmer(modform, data=mdat, family=binomial, fixef.prior = normal(cov = diag(9,vcov.dim)), control=glmerControl(optimizer="bobyqa"))
# }
warningmessages.blme
i<-8
mgmtvars[i]
mdat <- metricdat[metricdat[,mgmtvars[i]]!="none",]
table(mdat[,mgmtvars[i]], mdat$metric, mdat$success)
mdat <- subset(mdat, species!="ruff" & species!="dunlin")
# for the following categories, subset further because there aren't enough observations of either 0,1 or both
#   if (mgmtvars[i]=="reserve.desig") {
#     mdat <- subset(mdat, metric!="productivity")
#   }
if (mgmtvars[i]=="mowing") {
mdat <- subset(mdat, mowing!="applied")
}
#   if (mgmtvars[i]=="grazing") {
#     mdat <- subset(mdat, metric!="occupancy")
#   }
if (mgmtvars[i]=="fertpest") {
# mdat <- subset(mdat, fertpest!="applied")
mdat <- subset(mdat, metric!="occupancy")
}
if (mgmtvars[i]=="predator.control") {
mdat <- subset(mdat, predator.control!="reduced")
}
if (mgmtvars[i]=="water") {
# mdat <- subset(mdat, water!="reduced")
mdat <- subset(mdat, metric!="occupancy")
# model runs ok without 2 of curlew, oystercatcher and snipe, but model won't converge and has a very high max|grad| value when more than 1 of these species is included. Since they all have no successes for this management intervention and similar levels of failure, then combine together for the water analysis
# mdat <- subset(mdat, species!="curlew" & species!="oystercatcher")
# mdat$species <- ifelse(mdat$species=="oystercatcher" | mdat$species=="curlew" | mdat$species=="snipe", "OC/CU/SN", as.character(mdat$species))
}
mdat <- droplevels(mdat)
usedat[[i]] <- mdat
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$success))
# create different formulas to use depending on whether management variable is 1 or 2 levels
if (length(levels(mdat[,mgmtvars[i]])) > 1) {
modform <- as.formula(paste("success ~ ", mgmtvars[i], "*metric + (1|reference) + (1|species)", sep=""))
}
if (length(levels(mdat[,mgmtvars[i]])) < 2) {
modform <- as.formula("success ~ metric + (1|reference) + (1|species)")
}
# run a normal glmer model
m.ind.sp[[i]] <- glmer(modform, data=mdat, family=binomial, control=glmerControl(optimizer="bobyqa"))
# if ANY checkzeros==0, then there are categories which are missing any observations whatsoever, so will have problems with complete separation and/or convergence
# use bglmer since there are some cases of singularity produced by 0/1 not having any observations for some of the categorical variables
# calculate the dimensions of the covariance matrix for bglmer, based on the dimensions of the covariance matrix from the regular glmer model
# if (any(checkzeros==0)) {
vcov.dim <- nrow(vcov(m.ind.sp[[i]]))
m.ind.sp.blme[[i]] <- bglmer(modform, data=mdat, family=binomial, fixef.prior = normal(cov = diag(9,vcov.dim)), control=glmerControl(optimizer="bobyqa"))
# }
summary(m.ind.sp.blme[[8]])
summary(m.ind.sp[[8]])
summary(m.ind.sp[[8]])$vcov
summary(m.ind.sp[[8]])$varcor
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$success))
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$reference))
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$species))
(checkzeros <- table(mdat[,mgmtvars[i]], mdat$metric, mdat$success))
# create different formulas to use depending on whether management variable is 1 or 2 levels
if (length(levels(mdat[,mgmtvars[i]])) > 1) {
modform <- as.formula(paste("success ~ ", mgmtvars[i], "*metric + (1|reference) + (1|species)", sep=""))
}
if (length(levels(mdat[,mgmtvars[i]])) < 2) {
modform <- as.formula("success ~ metric + (1|reference)")# + (1|species)")
}
# run a normal glmer model
m.ind.sp[[i]] <- glmer(modform, data=mdat, family=binomial, control=glmerControl(optimizer="bobyqa"))
# if ANY checkzeros==0, then there are categories which are missing any observations whatsoever, so will have problems with complete separation and/or convergence
# use bglmer since there are some cases of singularity produced by 0/1 not having any observations for some of the categorical variables
# calculate the dimensions of the covariance matrix for bglmer, based on the dimensions of the covariance matrix from the regular glmer model
# if (any(checkzeros==0)) {
vcov.dim <- nrow(vcov(m.ind.sp[[i]]))
m.ind.sp.blme[[i]] <- bglmer(modform, data=mdat, family=binomial, fixef.prior = normal(cov = diag(9,vcov.dim)), control=glmerControl(optimizer="bobyqa"))
# }
# create different formulas to use depending on whether management variable is 1 or 2 levels
if (length(levels(mdat[,mgmtvars[i]])) > 1) {
modform <- as.formula(paste("success ~ ", mgmtvars[i], "*metric + (1|reference) + (1|species)", sep=""))
}
if (length(levels(mdat[,mgmtvars[i]])) < 2) {
modform <- as.formula("success ~ metric + (1|species)")# + (1|species)")
}
# run a normal glmer model
m.ind.sp[[i]] <- glmer(modform, data=mdat, family=binomial, control=glmerControl(optimizer="bobyqa"))
# if ANY checkzeros==0, then there are categories which are missing any observations whatsoever, so will have problems with complete separation and/or convergence
# use bglmer since there are some cases of singularity produced by 0/1 not having any observations for some of the categorical variables
# calculate the dimensions of the covariance matrix for bglmer, based on the dimensions of the covariance matrix from the regular glmer model
# if (any(checkzeros==0)) {
vcov.dim <- nrow(vcov(m.ind.sp[[i]]))
m.ind.sp.blme[[i]] <- bglmer(modform, data=mdat, family=binomial, fixef.prior = normal(cov = diag(9,vcov.dim)), control=glmerControl(optimizer="bobyqa"))
# }
if (length(levels(mdat[,mgmtvars[i]])) < 2) {
modform <- as.formula("success ~ metric + (1|reference) + (1|species)")
}
# run a normal glmer model
m.ind.sp[[i]] <- glmer(modform, data=mdat, family=binomial, control=glmerControl(optimizer="bobyqa"))
# if ANY checkzeros==0, then there are categories which are missing any observations whatsoever, so will have problems with complete separation and/or convergence
# use bglmer since there are some cases of singularity produced by 0/1 not having any observations for some of the categorical variables
# calculate the dimensions of the covariance matrix for bglmer, based on the dimensions of the covariance matrix from the regular glmer model
# if (any(checkzeros==0)) {
vcov.dim <- nrow(vcov(m.ind.sp[[i]]))
m.ind.sp.blme[[i]] <- bglmer(modform, data=mdat, family=binomial, fixef.prior = normal(cov = diag(9,vcov.dim)), control=glmerControl(optimizer="bobyqa"))
# }
summary(m.ind.sp.blme[[8]])
